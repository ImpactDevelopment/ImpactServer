<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Donate to impact</title>

    <!-- CSS  -->
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/min/style-min.css"/>

    <style>
        #amount:before {
            content: '$';
        }
    </style>

    <!-- Dependencies -->
    <script crossorigin="anonymous" src="https://polyfill.io/v3/polyfill.min.js"></script>
    <script type="text/javascript" src="/min/modernizr-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/api.js"></script>

    <!-- Stripe -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-143397381-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-143397381-1');
        
      var getOutboundLink = function(label) {
        gtag('event', 'click', {
            'event_category': 'outbound',
            'event_label': label,
            'transport_type': 'beacon'
        });
      }
    </script>
</head>
<body>
<header>
    <div class="navbar-fixed">
        <nav role="navigation">
            <div class="nav-wrapper container">
                <a href="/" class="brand-logo"><h1>Impact</h1></a>
            </div>
        </nav>
    </div>
</header>
 <div class="container">
    <form class="row" id="amount-form">
        <br><br>
        <div class="input-field col s9 push-l3">
            Donations of any size are appreciated! The minimum donation to receive premium features is $5. It is currently impossible to donate to Impact due to the termination of the PayPal account. This is being looked into and will be resolved as soon as possible.
        </div>
        <div class="input-field col s3 pull-l9">
            <span class="prefix">$</span>
            <input id="amount" type="number" data-type="currency" min="0.5" step="0.01" value="5"
                   pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
            <label for="amount" class="active">Amount</label>
        </div>
        <div class="range-field col s12">
            <input id="amountslider" type="range" min="1" max="100" value="5">
        </div>
    </form>
    <form class="row hidden" id="payment-form">
        <div class="col s12">
                <div id="payment-request-button"><!-- A Stripe Element will be inserted here. --></div>
                <hr /><!--TODO replace with "OR"-->
                <div id="card-element"><!-- Stripe Elements will create input elements here --></div>
                <div id="card-errors" role="alert"><!-- We'll put the error messages in this element --></div>
                <button id="submit">Donate</button>
        </div>
    </form>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>
<script>
    // TODO wrap some of this in a "next" callback to process after deciding amount

    function resetStripeElements() {
        $('#payment-request-button').innerHTML('')
        $("#card-element").innerHTML('')

    }

    var stripe = Stripe('pk_test_TYooMQauvdEDq54NiTphI7jx');//FIXME use actual public key
    resetStripeElements()
    var elements = stripe.elements();
    var style = {
        base: {
            color: "#32325d",
        }
    };

    // TODO get this from a create payment request upon completing amount-form
    var payment = {
        amount: 500,
        clientSecret: "blahblahblah",
        currency: "usd"
    }

    // paymentRequest is used for Apple Pay, Google Pay, and Chrome "click to pay"
    var paymentRequest = stripe.paymentRequest({
        country: 'US',
        currency: 'usd',
        total: {
            label: 'Donation',
            amount: payment.amount, // This must match the amount on the PaymentIntent we have a ClientSecret for
        },
        requestPayerName: true,
        requestPayerEmail: true,
    });

    var prButton = elements.create('paymentRequestButton', {
        paymentRequest: paymentRequest,
    });

    // Check the availability of the Payment Request API first.
    paymentRequest.canMakePayment().then(function(result) {
        if (result) {
            prButton.mount('#payment-request-button');
        } else {
            // TODO hide anything else related such as the "OR" separator
            document.getElementById('payment-request-button').style.display = 'none';
        }
    });

    paymentRequest.on('paymentmethod', function(event) {
        // Confirm the PaymentIntent without handling potential next actions (yet).
        stripe.confirmCardPayment(
            payment.clientSecret,
            {payment_method: event.paymentMethod.id},
            {handleActions: false}
        ).then(function(confirmResult) {
            if (confirmResult.error) {
                // Report to the browser that the payment failed, prompting it to
                // re-show the payment interface, or show an error message and close
                // the payment interface.
                event.complete('fail');
            } else {
                // Report to the browser that the confirmation was successful, prompting
                // it to close the browser payment method collection interface.
                event.complete('success');
                // Check if the PaymentIntent requires any actions and if so let Stripe.js
                // handle the flow.
                if (confirmResult.paymentIntent.status === "requires_action") {
                    // Let Stripe.js handle the rest of the payment flow.
                    // FIXME this bit should be similar/identical to the card api callback - delegate to a shared function?
                    stripe.confirmCardPayment(payment.clientSecret).then(function(result) {
                        if (result.error) {
                            // TODO The payment failed -- ask your customer for a new payment method.
                        } else {
                            // TODO The payment has succeeded.
                        }
                    });
                } else {
                    // TODO The payment has succeeded.
                }
            }
        });
    });

    // card is used for manual card entry/autofill
    var card = elements.create("card", { style: style });
    card.mount("#card-element");

    card.on('change', function(event) {
        var displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    document.getElementById('payment-form').addEventListener('submit', function(event) {
        event.preventDefault();

        // Submit clientSecret to Stripe
        // TODO stripe.confirmCardPayment may take several seconds to complete. During that time,
        //      disable your form from being resubmitted and show a waiting indicator like a spinner.
        //      If you receive an error, show it to the customer, re-enable the form, and hide the
        //      waiting indicator.
        stripe.confirmCardPayment(payment.clientSecret, {
            payment_method: {
                card: card,
                billing_details: { // TODO I think we're supposed to supply form data for stuff like billing address - stripe only handles the card form i guess?
                    name: 'Jenny Rosen'//FIXME
                }
            }
        }).then(function(result) {
            if (result.error) {
                // TODO Show error to the user (e.g., insufficient funds)
                console.log(result.error.message);
            } else {
                // The payment has been processed!
                if (result.paymentIntent.status === 'succeeded') {
                    // TODO Show a success message to the user
                    console.log("success");
                    // There's a risk of the customer closing the window before callback
                    // execution. Set up a webhook or plugin to listen for the
                    // payment_intent.succeeded event that handles any business critical
                    // post-payment actions.
                }
            }
        });
    });
</script>
<script>
    // TODO accept local currency?
    var currency = 'USD'; // https://www.currency-iso.org/dam/downloads/lists/list_one.xml
    var currencyInput = document.getElementById('amount');
    var currencySlider = document.getElementById('amountslider');

    currencyInput.addEventListener('input', () => {
        if (currencySlider.value !== currencyInput.value)
            currencySlider.value = currencyInput.value;

    });
    currencySlider.addEventListener('input', () => {
        if (currencyInput.value !== currencySlider.value)
            currencyInput.value = currencySlider.value;

    });

    function localStringToNumber(s) {
        return Number(String(s).replace(/[^0-9.-]+/g, ""));
    }

    function formatNumber(n) {
        // format number 1000000 to 1,234,567
        return n.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    }


    function formatCurrency(input, blur) {
        // appends $ to value, validates decimal side
        // and puts cursor back in right position.

        // get input value
        var input_val = input.val();

        // don't validate empty input
        if (input_val === "") {
            return;
        }

        // original length
        var original_len = input_val.length;

        // initial caret position
        var caret_pos = input.prop("selectionStart");

        // check for decimal
        if (input_val.indexOf(".") >= 0) {

            // get position of first decimal
            // this prevents multiple decimals from
            // being entered
            var decimal_pos = input_val.indexOf(".");

            // split number by decimal point
            var left_side = input_val.substring(0, decimal_pos);
            var right_side = input_val.substring(decimal_pos);

            // add commas to left side of number
            left_side = formatNumber(left_side);

            // validate right side
            right_side = formatNumber(right_side);

            // On blur make sure 2 numbers after decimal
            if (blur === "blur") {
                right_side += "00";
            }

            // Limit decimal to only 2 digits
            right_side = right_side.substring(0, 2);

            // join number by .
            input_val = "$" + left_side + "." + right_side;

        } else {
            // no decimal entered
            // add commas to number
            // remove all non-digits
            input_val = formatNumber(input_val);
            input_val = "$" + input_val;

            // final formatting
            if (blur === "blur") {
                input_val += ".00";
            }
        }

        // send updated string to input
        input.value = input_val;

        // put caret back in the right position
        var updated_len = input_val.length;
        caret_pos = updated_len - original_len + caret_pos;
        input[0].setSelectionRange(caret_pos, caret_pos);
    }

    function qualifiesForPerks() {
        return localStringToNumber(currencyInput.value) >= 5;
    }
</script>
</body>
</html>
