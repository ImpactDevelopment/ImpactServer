<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Donate to Impact</title>
    <meta name="description" content="A demo of a card payment on Stripe" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Dependencies -->
    <script crossorigin="anonymous" src="https://polyfill.io/v3/polyfill.min.js"></script>
    <script type="text/javascript" src="/min/modernizr-min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="/js/api.js"></script>
    <script type="text/javascript" src="https://js.stripe.com/v3/"></script>

    <!-- CSS  -->
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
    <link rel="stylesheet" type="text/css"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" type="text/css" href="/min/style-min.css"/>

    <style>
        #amount:before {
            content: '$';
        }
    </style>
</head>
<body>
<form id="amount-form" class="container ">
    <div class="row">
        <div class="input-field col s12">
            Donations of any size are appreciated! The minimum donation to receive premium features is $5. It is currently impossible to donate to Impact due to the termination of the PayPal account. This is being looked into and will be resolved as soon as possible.
        </div>
        <div class="input-field col s12 l8 push-l4">
            <input type="email" id="email" name="email" placeholder="Email" />
        </div>
        <div class="input-field col s12 l4 pull-l8">
            <span class="prefix">$</span>
            <input id="amount" type="number" data-type="currency" min="0.5" step="0.01" value="5"
                   pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
            <label for="amount" class="active">Amount</label>
        </div>
        <div class="input-field col s12">
            <button type="submit" form="amount-form" disabled class="btn waves-effect waves-light">
                <span class="button-text">Next</span>
            </button>
            <div class="preloader-wrapper small active hidden">
                <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
        <p id="amount-error" class="input-field col s12 error" role="alert"></p>
    </div>
</form>
<form id="payment-form" class="container hidden">
    <div class="row">
        <div class="info">
            <h4>Thanks, your donation of <span class="amount"></span> will be greatly appreciated!</h4>
            <p class="hidden show-if-premium">As your donation is $5 or more, you will be able to create an Impact Account to receive perks!</p>
            <p class="hidden show-if-not-premium">If you wish to register an Impact Account to receive perks, please donate $5 or more.</p>
            <p>An email will be sent to <span class="email"></span> with confirmation of your payment.</p>
            <p><a href="#" id="back-button">Click here to amend any of these details.</a></p>
        </div>
        <div id="payment-request-button"><!-- Stripe.js injects the PaymentRequest Element here --></div>
        <div id="card-element"><!-- Stripe.js injects the Card Element here --></div>
        <button type="submit" form="payment-form" disabled>
            <span class="button-text">Donate</span>
        </button>
        <div class="preloader-wrapper small active hidden">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div>
                <div class="gap-patch">
                    <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
        <p id="card-error" class="error" role="alert"></p>
    </div>
</form>
<div class="container result-message hidden">
    <div class="row">
        <h4>Thank you for your donation! Your payment ID is: <span id="payment-id"></span></h4>
        <div class="preloader-wrapper small active hidden">
            <div class="spinner-layer spinner-blue-only">
                <div class="circle-clipper left">
                    <div class="circle"></div>
                </div>
                <div class="gap-patch">
                    <div class="circle"></div>
                </div>
                <div class="circle-clipper right">
                    <div class="circle"></div>
                </div>
            </div>
        </div>
        <p class="success">
            <span>Your Impact Account registration token is:</span>
            <span id="token"></span>
            <a href="#" id="register">Click here to register an Impact Account</a>
        </p>
        <p class="error" role="alert"></p>
    </div>
</div>
<script type="text/javascript">
    // A reference to Stripe.js initialized with your real test publishable API key.
    // TODO transition to live keys
    var stripe = Stripe('pk_test_51HV1OpAARTsU1r4vavYYukCY25TqyL9et2w8dRzVvwUk6UydTp4zvxwExYVyHuPcXs53Ya26Of2UUbJ3zFjeE3JW00MtAMB1AE', {
        apiVersion: '2020-08-27',
    });

    var emailRegex = /^[a-zA-Z0-9.!#$%&'*+\/=?^_{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/

    // Keep track of the current PaymentIntent so we know whether or not to create a new one;
    // useful when the user goes back and forth between the amount form and the payment form
    var currentPaymentIntent = null

    // TODO replace these change listeners with materializecss form validation?
    var amountEventHandler = function (event) {
        var val = $('#amount').val().trim()
        var error = validateAmountValue(val)
        if (error !== '') {
            showError($('#amount-form'), error)
            console.error(error)
        }
        $('#amount-form button').attr('disabled', error !== "")
    }
    $('#amount').change(amountEventHandler).keyup(amountEventHandler)

    var emailEventHandler = function (event) {
        var val = $('#email').val().trim()
        var error = validateEmail(val)
        if (error !== '') {
            showError($('#amount-form'), error)
            console.error(error)
        }
        $('#amount-form button').attr('disabled', error !== "")
    }
    $('#email').change(emailEventHandler).keyup(emailEventHandler)

    $('#amount-form').submit(function (event) {
        event.preventDefault()

        // Validate email
        var email = $('#email').val()
        var emailError = validateEmail(email)
        if (emailError !== '') {
            showError($('#amount-form'), error)
            console.error(amountError)
            return
        }


        // Validate and process the amount value
        // It must be a valid number and must then become an int by multiplying by 100
        var amount = $('#amount').val().trim()
        var amountError = validateAmountValue(amount)
        if (amountError !== '') {
            showError($('#amount-form'), error)
            console.error(amountError)
            return
        }
        amount = Math.floor(amount * 100)

        // Show a spinner while creating PaymentIntent
        loading($('#amount-form'), true)

        // If the current (old) PaymentIntent is identical to the new updated amount/email values,
        // don't bother calling api.createPayment since we don't need a new PaymentIntent
        if (currentPaymentIntent && !hasPaymentChanged(currentPaymentIntent, amount, email)) {
            setupPaymentForm(currentPaymentIntent)
            return
        }

        api.createPayment(amount, email)
            .then(function (result) {
                return currentPaymentIntent = result
            })
            .then(setupPaymentForm)
            .catch(function (error) {
                currentPaymentIntent = null
                loading($('#amount-form'), false)
                showError($('#amount-form'), error)
            })
    })

    $('#back-button').click(function (event) {
        event.preventDefault()

        // Just show the amount form without resetting any state
        // We will rely on the "next" button to handle any changes to state

        var paymentf = $('#payment-form')
        var amountf = $('#amount-form')
        loading(paymentf, false)
        loading(amountf, false)
        paymentf.addClass('hidden')
        amountf.removeClass('hidden')
        amountf.find('#amount').focus()
    })

    var setupPaymentForm = function (data) {
        // Display some info
        $('#payment-form .amount').text('$' + (Math.floor(data.amount) / 100).toFixed(2))
        $('#payment-form .email').text(data.email)
        if (data.amount < 500) {
            $('#payment-form .show-if-not-premium').removeClass('hidden')
            $('#payment-form .show-if-premium').addClass('hidden')
        } else {
            $('#payment-form .show-if-premium').removeClass('hidden')
            $('#payment-form .show-if-not-premium').addClass('hidden')
        }

        // Stripe stuff
        var elements = stripe.elements();
        var style = {
            base: {
                color: "#32325d",
                fontFamily: 'Arial, sans-serif',
                fontSmoothing: "antialiased",
                fontSize: "16px",
                "::placeholder": {
                    color: "#32325d"
                }
            },
            invalid: {
                fontFamily: 'Arial, sans-serif',
                color: "#fa755a",
                iconColor: "#fa755a"
            }
        };

        // Setup PaymentRequest button
        var paymentRequest = stripe.paymentRequest({
            country: 'US',
            currency: 'usd',
            total: {
                label: 'Donation',
                amount: data['amount'],
            },
            requestPayerName: false,
            requestPayerEmail: true, // Requesting name, email, or phone will automatically request billing address on Apple Pay which is useful for anti-fraud
            requestShipping: false
        });
        var prButton = elements.create('paymentRequestButton', {
            paymentRequest: paymentRequest,
        });

        // Check the availability of the Payment Request API first.
        paymentRequest.canMakePayment().then(function(result) {
            if (result) {
                // Mount the button
                prButton.mount('#payment-request-button');

                // Setup submit handler for PaymentRequest
                paymentRequest.on('paymentmethod', function(event) {
                    payWithPaymentRequest(stripe, event, data['client_secret'])
                });
            } else {
                document.getElementById('payment-request-button').style.display = 'none';
            }
        });

        // Setup card form
        var card = elements.create("card", { style: style });
        card.mount("#card-element"); // Stripe injects an iframe into the DOM
        card.on("change", function (event) {
            // Disable the Pay button if there are no card details in the Element
            $('#payment-form button[type=submit]').attr('disabled', event.empty)
            $("#card-error").text(event.error ? event.error.message : "")
        });

        // Setup submit handler
        $("#payment-form")
            .off('submit') // Remove any other handlers - prevent duplicate handlers when re-initialising form
            .on('submit', function(event) {
                event.preventDefault();
                // Complete payment when the submit button is clicked
                payWithCard(stripe, card, data['client_secret']);
            });

        // Hide the amount form and show the payment form
        $('#amount-form').addClass('hidden')
        $('#payment-form').removeClass('hidden')
        loading($('#amount-form'), false)
    }

    var validateEmail = function (email) {
        if (email === '') {
            return 'Email is empty'
        }
        if (email.length < 3 || email.length > 254) {
            return 'Email must be between 3 and 254 characters'
        }
        if (!emailRegex.test(email)) {
            return 'Invalid email format'
        }
        return ''
    }

    // Check if amount value is valid
    // If valid returns empty string
    // If invalid returns an error
    // TODO consider returning an object so we can have additional data such as whether or not to show the error?
    var validateAmountValue = function(value) {
        if (value === '') {
            return 'Amount is empty'
        }
        if (isNaN(value)) {
            return '"' + value + '" is not a number'
        }
        if (value < 0) {
            return '"' + value + '" is negative'
        }
        if (value === 0) {
            return 'Amount is zero'
        }
        return '' // No error
    }

    var hasPaymentChanged = function (payment, amount, email) {
        return !(payment.amount === amount && payment.email === email);

    }

    // Calls stripe.confirmCardPayment
    // If the card requires authentication Stripe shows a pop-up modal to
    // prompt the user to enter authentication details without leaving your page.
    var payWithPaymentRequest = function(stripe, event, clientSecret) {
        // Confirm the PaymentIntent without handling potential next actions (yet).
        stripe.confirmCardPayment(
            clientSecret,
            {
                payment_method: event.paymentMethod.id
            },
            {
                handleActions: false
            }
        ).then(function(confirmResult) {
            if (confirmResult.error) {
                // Report to the browser that the payment failed, prompting it to
                // re-show the payment interface, or show an error message and close
                // the payment interface.
                event.complete('fail');
            } else {
                // Report to the browser that the confirmation was successful, prompting
                // it to close the browser payment method collection interface.
                event.complete('success');
                // Check if the PaymentIntent requires any actions and if so let Stripe.js
                // handle the flow. If using an API version older than "2019-02-11" instead
                // instead check for: `paymentIntent.status === "requires_source_action"`.
                if (confirmResult.paymentIntent.status === "requires_action") {
                    // Let Stripe.js handle the rest of the payment flow.
                    stripe.confirmCardPayment(clientSecret).then(function(newConfirmResult) {
                        if (newConfirmResult.error) {
                            // The payment failed -- TODO ask user for a new payment method?
                            showError($('#payment-form'), newConfirmResult.error.message);
                        } else {
                            // The payment has succeeded.
                            orderComplete(newConfirmResult.paymentIntent)
                        }
                    });
                } else {
                    // The payment has succeeded.
                    orderComplete(confirmResult.paymentIntent)
                }
            }
        });
    };

    // Calls stripe.confirmCardPayment
    // If the card requires authentication Stripe shows a pop-up modal to
    // prompt the user to enter authentication details without leaving your page.
    var payWithCard = function(stripe, card, clientSecret) {
        loading($('#payment-form'), true);
        stripe.confirmCardPayment(
            clientSecret,
            {
                payment_method: {
                    card: card
                }
            }
        ).then(function(confirmResult) {
            if (confirmResult.error) {
                // Show error to your customer
                showError($('#payment-form'), confirmResult.error.message);
            } else {
                // The payment succeeded!
                orderComplete(confirmResult.paymentIntent);
            }
        });
    };

    /* ------- UI helpers ------- */
    /* TODO: use materializecss where appropriate */

    // Shows a success message when the payment is complete
    var orderComplete = function(payment) {
        loading($('#payment-form'), false);
        loading($('.result-message'), true)
        $("button[type=submit]").attr('disabled', true)
        $('#payment-form').addClass('hidden')
        $('.result-message .success').addClass('hidden')
        $('.result-message .error').addClass('hidden')

        $('#payment-id').text(payment['id'])
        $('.result-message').removeClass('hidden')
        api.redeemPayment(payment['id'], payment['receipt_email'])
            .then(function (token) {
                $('#token').text(token)
                $('#register').attr('href', '/register?token='+encodeURIComponent(token))
                loading($('.result-message'), false)
                $('.result-message .error').addClass('hidden')
                $('.result-message .success').removeClass('hidden')
            })
            .catch(function (error) {
                // TODO handle some errors gracefully e.g. amount too small
                loading($('.result-message'), false)
                $('.result-message .success').addClass('hidden')
                $('.result-message .error')
                    .removeClass('hidden')
                    .text(error)
            })
    };

    // Show the customer the error from Stripe if their card fails to charge
    var showError = function(parent, errorMsgText) {
        loading(parent, false);
        var err = parent.find('.error')
        err.text(errorMsgText)
        // FIXME if multiple errors occur within 4s, the original timeout will still wipe the latest error message
        setTimeout(function() {
            err.text("")
        }, 4000);
    };

    // Show a spinner on form submission
    // Expects a jQuery object and a boolean
    var loading = function(form, isLoading) {
        if (isLoading) {
            // Disable the button and show a spinner
            form.find("button[type=submit]").attr('disabled', true).addClass('hidden');
            form.find(".preloader-wrapper").removeClass("hidden");
            form.find(".button-text").add("hiddenClass");
        } else {
            form.find("button[type=submit]").attr('disabled', false).removeClass('hidden');
            form.find(".preloader-wrapper").addClass("hidden");
            form.find(".button-text").removeClass("hidden");
        }
    };
</script>
</body>
</html>