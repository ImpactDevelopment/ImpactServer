<!doctype html>
<html lang="en">
<head>
<title>Impact Account</title>

<!-- Dependencies -->
<script crossorigin="anonymous" src="https://polyfill.io/v3/polyfill.min.js"></script>
<script type="text/javascript" src="/min/modernizr-min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="/js/api.js"></script>
<script>
    // Called by the oauth popup window
    function discordCallback(discordToken) {
        api.login(discordToken)
        .then(function(result) {
            // TODO instead or reloading just call an init() func
            window.location.reload(false)
        })
        .catch(function(error) {
            $("#discord_login_msg").text(error)
        })
    }

    // popup centered on window
    // https://stackoverflow.com/a/32261263
    function popupOverWindow(url, title, w, h) {
        var y = window.top.outerHeight / 2 + window.top.screenY - ( h / 2)
        var x = window.top.outerWidth / 2 + window.top.screenX - ( w / 2)
        var newWindow = window.open(url, title, 'toolbar=no,location=no,directories=no,status=no,menubar=no,copyhistory=no,width='+w+',height='+h+',top='+y+',left='+x)
        if (window.focus) {
            newWindow.focus()
        }
        return newWindow
    }
</script>

<!-- CSS  -->
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
<link rel="stylesheet" type="text/css" href="/min/style-min.css"/>
<style>
    .fade-in {
        opacity: 1;
        -webkit-transition: opacity .33s ease;
        transition: opacity .33s ease;
    }
    .invisible {
        opacity: 0!important;
    }
    #discord_login_btn {
        background-color: #7289da;
        color: #fff;
    }
</style>
</head>
<body>
<header>
    <div class="navbar-fixed">
        <nav role="navigation">
            <div class="nav-wrapper container">
                <a href="/" class="brand-logo"><h1>Impact</h1></a>
            </div>
        </nav>
    </div>
</header>

<noscript>This page requires javascript to function</noscript>

<div id="fouc" class="section container fade-in invisible">
    <!-- novalidate doesn't block materialize's error messages but does allow validateForm to take chage of the final validation -->
    <form id="login" class="row hidden center" novalidate>
        <p id="expired" class="col s12 large_text hidden">Your session expired and you have been logged out.</p>
        <div class="input-field col s12">
            <a id="discord_login_btn" class="btn waves-effect waves-light">Login with discord</a>
            <p id="discord_login_msg"></p>
        </div>
        <div class="input-field col s12 center grey-text">
            <p>or</p>
        </div>
        <div class="input-field col s12 m6">
            <input type="email" name="email" id="email" class="validate" required/>
            <label for="email">Email</label>
        </div>
        <div class="input-field col s4 m4">
            <input type="password" name="password" id="password" class="validate" autocomplete required/>
            <label for="password">Password</label>
            <span class="helper-text"><a href="/forgotpassword.html">Click here if you've forgotten your password</a></span>
        </div>
        <div class="input-field col s2">
            <button class="btn waves-effect waves-light" type="submit" name="action">
                Login
            </button>
        </div>
        <p id="form_msg" class="col s12 helper-text error"></p>
    </form>
    <div id="dashboard" class="row hidden">
        <h4 class="col s12">Impact Account dashboard</h4>
        <form novalidate id="info" class="row fade-in invisible">
            <!-- Materialize doesn't support text input nested within label, so we need a for-id relationship -->
            <div class="input-field col s12">
                <input type="email" name="email" id="edit_email"/>
                <label for="edit_email">Email</label>
            </div>
            <div class="input-field col s12">
                <!-- Materialize DOES support checkboxes nested within label, which simplifies things -->
                <p>
                    <label>
                        <input name="incognito" class="filled-in" type="checkbox" value="true" />
                        <span>Incognito mode</span>
                    </label>
                </p>
                <p>
                    <label>
                        <input name="legacy_enabled" class="filled-in" type="checkbox" value="true" />
                        <span>Enable premium on Impact 4.7 and below</span>
                    </label>
                </p>
            </div>
            <div class="input-field col s12">
                <button class="btn waves-effect waves-light" type="submit" name="action" disabled>
                    Update
                </button>
            </div>
            <p id="info_msg" class="col s12 helper-text error"></p>
        </form>
        <a id="logout" class="btn waves-effect waves-light" href="#">Logout</a>
    </div>
</div>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.99.0/js/materialize.min.js"></script>
<script>
    (function init() {
        $("#fouc").addClass("invisible")

        if (api.isLoggedIn()) {
            $("#dashboard").removeClass("hidden")
            $("#login").addClass("hidden")
            api.me()
                .then(function (user) {
                    // Populate the update form with the user's info
                    var form = document.getElementById("info")
                    $.each(form.elements, function(i, elm) {
                        if (api.user.hasOwnProperty(elm.name)) {
                            var value = api.user[elm.name]
                            switch (typeof value) {
                                case "boolean": elm.checked = value; break;
                                default: elm.value = value;
                            }
                        }
                    })

                    // Update meterialize form magic after pre-filling fields, etc
                    if (window.Materialize && window.Materialize.updateTextFields) {
                        window.Materialize.updateTextFields()
                    }

                    $(form).removeClass("invisible")
                })
                .catch(function (error) {
                    if (error === "invalid key") {
                        $("#dashboard").addClass("hidden")
                        $("#expired").removeClass("hidden")
                        $("#login").removeClass("hidden")
                        api.logout()
                    }
                    $("#info")
                        .text(error)
                        .removeClass("invisible")
                })
        } else {
            $("#dashboard").addClass("hidden")
            $("#login").removeClass("hidden")
        }

        $("#discord_login_btn").click(function (event) {
            event.preventDefault()
            popupOverWindow(
                "/discord_oauth.html",
                "oauth", 600, 800
            )
        })

        $("#login").submit(function (event) {
            event.preventDefault()

            var email = $("#email").val()
            var password = $("#password").val()

            // validate
            var msg = ""
            if (!email) msg += ("<br>Email is required")
            if (!password) msg += ("<br>Password is required")
            $("#form_msg").html(msg)
            if (msg) return

            api.login(email, password)
                .then(function(result) {
                    // The api has logged us in
                    init()
                })
                .catch(function(error) {
                    console.error(error)
                })
        })

        function onEditInfo (event) {
            // Don't use jquery here; the native DOM API let's us do form[name] and form.elements
            var form = document.getElementById("info");
            var infoChanged = false;

            // Check if the form elements match with the cached user object
            // - If an element matches, disable validation for that element
            // - If any element is different, set infoChanged to true
            $.each(form.elements, function(i, elm) {
                if (api.user.hasOwnProperty(elm.name)) {
                    // Get userValue and cast formValue to its type
                    var userValue = api.user[elm.name]
                    var formValue = elm.value
                    switch (typeof userValue) {
                        case "boolean": formValue = !!elm.checked; break;
                        case "number": formValue = 0+formValue; break;
                    }

                    // If the form matches the user's value, show it without validation
                    // otherwise enable validation for this field and mark the form as changed
                    if (userValue === formValue) {
                        $(elm).removeClass("validate valid invalid")
                    } else {
                        $(elm).addClass("validate")
                        infoChanged = true
                    }
                }
            })

            // Disable submit if no change
            $("#info button[type=submit]").attr("disabled", !infoChanged)
        }
        $("#info")
            .submit(function (event) {
                event.preventDefault()

                // Don't submit if the submit button is disabled (prevent submit-on-enter if no change)
                if ($("#info button[type=submit]").attr("disabled")) return;

                // TODO send a request to update user info
                alert("TODO: send this stuff to an API: " + $("#info").serialize())
            })
            .keyup(onEditInfo).click(onEditInfo).change(onEditInfo)

        $("#logout").click(function (event) {
            event.preventDefault()
            api.logout()
            init()
        })

        // Fade in
        $("#fouc").removeClass("invisible")
    })()
</script>
</body>
</html>